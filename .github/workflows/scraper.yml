name: FB Ads Scraper Diário

# Permissões para permitir push para branch debug-artifacts via GITHUB_TOKEN
permissions:
  contents: write

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  scraper:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        batch_id: [1,2,3,4] # TOTAL_BATCHES=4 (mude aqui para 8 se quiser mais batches)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright
          restore-keys: |
            ${{ runner.os }}-playwright

      - name: Instalar dependências
        run: npm ci

      - name: Instalar navegadores Playwright
        run: npx playwright install --with-deps chromium

      - name: Rodar Scraper (batch ${{ matrix.batch_id }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TOTAL_BATCHES: 4
          BATCH_ID: ${{ matrix.batch_id }}
          PROCESS_LIMIT: 150
          PARALLEL: 5
          WORKER_ID: runner-${{ runner.name }}-batch-${{ matrix.batch_id }}-run-${{ github.run_id }}
        run: node scraper.mjs

      - name: Listar arquivos debug (imprime nomes e primeiras linhas dos .html)
        if: always()
        run: |
          echo "Runner workspace: $RUNNER_WORKSPACE"
          echo "Debug path: ./debug"
          if [ -d "./debug" ]; then
            ls -la ./debug || true
            for f in ./debug/*; do
              if [ -f "$f" ]; then
                echo "---- $f ----"
                case "$f" in
                  *.html) sed -n '1,200p' "$f" || true ;;
                  *.png) echo "(imagem PNG) $f" ;;
                  *) sed -n '1,100p' "$f" || true ;;
                esac
                echo ""
              fi
            done
          else
            echo "Pasta ./debug não encontrada"
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-${{ github.run_id }}-batch-${{ matrix.batch_id }}
          path: debug
          retention-days: 1

      - name: Commit debug files to debug-artifacts branch
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -d "./debug" ]; then
            echo "Não há pasta ./debug para commitar. Saindo."
            exit 0
          fi
          tmpdir=$(mktemp -d)
          cp -r ./debug "$tmpdir"/debug || true
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin
          if git ls-remote --exit-code --heads origin debug-artifacts; then
            git checkout -B debug-artifacts origin/debug-artifacts
            git rm -rf . || true
          else
            git checkout --orphan debug-artifacts
            git rm -rf . || true
          fi
          mkdir -p debug
          if [ -d "$tmpdir/debug" ]; then
            cp -r "$tmpdir"/debug/* debug/ || true
          fi
          git add -A debug || true
          if git diff --cached --quiet; then
            echo "Sem mudanças a commitar no branch debug-artifacts"
          else
            git commit -m "chore(debug): upload debug artifacts for run $GITHUB_RUN_ID batch ${MATRIX_BATCH_ID:-${{ matrix.batch_id }}}"
            git push --force "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" HEAD:debug-artifacts
            echo "Push para branch debug-artifacts concluído."
          fi
