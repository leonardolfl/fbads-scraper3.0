# Test workflow para scraper_nulls.mjs
# Executa 4 workers (matrix 0..3) para reprocessar ofertas com activeAds IS NULL
# Uso: abra Actions -> selecione "Test Scraper NULLs" -> Run workflow (dispatch manual)
on:
  workflow_dispatch: {}

jobs:
  scraper-nulls-test:
    name: Testar scraper_nulls (worker ${{ matrix.worker_index }})
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
      options: --shm-size=1g

    strategy:
      matrix:
        worker_index: [0, 1, 2, 3]
      fail-fast: false

    env:
      # Configurações principais (ajuste conforme necessário)
      TOTAL_WORKERS: 4
      WORKER_INDEX: ${{ matrix.worker_index }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      LOG_LEVEL: info
      PARALLEL: 3
      WAIT_TIME: 13000
      NAV_TIMEOUT: 90000
      SELECTOR_TIMEOUT: 15000
      RETRY_ATTEMPTS: 1
      DEBUG: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Verify files present
        run: |
          echo "Listing root files for quick verification"
          ls -la
          if [ ! -f scraper_nulls.mjs ]; then
            echo "ERROR: scraper_nulls.mjs not found in repo root" >&2
            exit 2
          fi
          if [ ! -f supabase.js ]; then
            echo "WARNING: supabase.js not found - ensure you provide client implementation" >&2
          fi

      - name: Run NULLs scraper (worker ${{ matrix.worker_index }})
        run: |
          echo "Starting scraper_nulls worker $WORKER_INDEX / $TOTAL_WORKERS"
          node scraper_nulls.mjs
        # timeout razoável para cada worker (adjust if needed)
        timeout-minutes: 30
